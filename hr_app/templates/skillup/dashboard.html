{% extends 'base.html' %}
{% block title %}Skill-Up Dashboard - NextGenHR{% endblock %}
{% block extra_head %}
<style>
.skillup-dashboard { max-width: 1400px; margin: 0 auto; padding: 2rem; }
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
.stat-card { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); text-align: center; }
.stat-number { font-size: 2.5rem; font-weight: bold; color: #007bff; }
.stat-label { color: #666; font-size: 0.9rem; margin-top: 0.5rem; }
.courses-section { background: white; border-radius: 12px; padding: 2rem; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 2rem; }
.course-card { background: #f8f9fa; border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem; border-left: 4px solid #007bff; transition: all 0.3s ease; }
.course-card:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.1); }
.course-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; }
.course-title { font-size: 1.25rem; font-weight: 600; color: #333; margin: 0; }
.status-badge { padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
.status-assigned { background: #fff3cd; color: #856404; }
.status-in-progress { background: #d1ecf1; color: #0c5460; }
.status-completed { background: #d4edda; color: #155724; }
.status-failed { background: #f8d7da; color: #721c24; }
.progress-bar { width: 100%; height: 8px; background: #e9ecef; border-radius: 4px; overflow: hidden; margin: 0.75rem 0; }
.progress-fill { height: 100%; background: linear-gradient(90deg, #007bff, #0056b3); transition: width 0.3s ease; }
.course-meta { display: flex; gap: 1rem; margin: 1rem 0; font-size: 0.875rem; color: #666; }
.course-actions { display: flex; gap: 0.75rem; margin-top: 1rem; }
.btn-primary { background: #007bff; color: white; padding: 0.5rem 1rem; border: none; border-radius: 6px; cursor: pointer; text-decoration: none; font-size: 0.875rem; transition: background 0.3s; }
.btn-primary:hover { background: #0056b3; }
.btn-secondary { background: #6c757d; color: white; }
.btn-secondary:hover { background: #5a6268; }
.btn-success { background: #28a745; color: white; }
.btn-success:hover { background: #218838; }
.assessment-info { background: #e3f2fd; padding: 1rem; border-radius: 6px; margin: 1rem 0; }
.video-icon { color: #1976d2; }
.no-courses { text-align: center; padding: 3rem; color: #666; }
.filter-bar { display: flex; gap: 1rem; align-items: center; margin-bottom: 2rem; }
.filter-select { padding: 0.5rem 1rem; border: 1px solid #ddd; border-radius: 6px; background: white; }
</style>
{% endblock %}

{% block content %}
<div class="skillup-dashboard">
    <div class="page-header" style="margin-bottom: 2rem;">
        <h1 style="color: #333; margin-bottom: 0.5rem;">üìö Skill-Up Dashboard</h1>
        <p style="color: #666;">Track your assigned courses and video assessments</p>
    </div>

    <!-- Statistics Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number">{{ total_assignments }}</div>
            <div class="stat-label">Total Assignments</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ in_progress_count }}</div>
            <div class="stat-label">In Progress</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ completed_count }}</div>
            <div class="stat-label">Completed</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ avg_score|floatformat:1 }}%</div>
            <div class="stat-label">Average Progress</div>
        </div>
    </div>

    <!-- Filter Bar -->
    <div class="filter-bar">
        <label for="statusFilter">Filter by Status:</label>
        <select id="statusFilter" class="filter-select" onchange="filterCourses()">
            <option value="all">All Courses</option>
            <option value="recommended">Recommended</option>
            <option value="in_progress">In Progress</option>
            <option value="completed">Completed</option>
            <option value="paused">Paused</option>
        </select>
        
        <label for="typeFilter">Assignment Type:</label>
        <select id="typeFilter" class="filter-select" onchange="filterCourses()">
            <option value="all">All Types</option>
            <option value="feedback_based">Feedback Based</option>
            <option value="manual">Manual Assignment</option>
            <option value="ai_recommended">AI Recommended</option>
        </select>
    </div>

    <!-- Courses Section -->
    <div class="courses-section">
        <h2 style="margin-bottom: 1.5rem; color: #333;">Your Assigned Courses</h2>
        
        {% if assignments %}
            {% for assignment in assignments %}
            <div class="course-card" data-status="{{ assignment.status }}" data-type="feedback_based">
                <div class="course-header">
                    <div>
                        <h3 class="course-title">{{ assignment.course.title }}</h3>
                        <p style="margin: 0.5rem 0; color: #666;">{{ assignment.course.description|truncatewords:20 }}</p>
                    </div>
                    <span class="status-badge status-{{ assignment.status }}">
                        {% if assignment.status == 'recommended' %}üìã Recommended
                        {% elif assignment.status == 'in_progress' %}üîÑ In Progress
                        {% elif assignment.status == 'completed' %}‚úÖ Completed
                        {% elif assignment.status == 'failed' %}‚ùå Failed
                        {% else %}‚è∏Ô∏è {{ assignment.get_status_display }}
                        {% endif %}
                    </span>
                </div>

                <div class="course-meta">
                    <span>ÔøΩ Created: {{ assignment.created_at|date:"M d, Y" }}</span>
                    <span>‚è±Ô∏è Duration: {{ assignment.course.duration|default:"N/A" }} hours</span>
                    <span>üéØ Priority: {{ assignment.get_priority_level_display }}</span>
                    <span>üìà Gap: {{ assignment.skill_gap_identified|truncatewords:3 }}</span>
                    <span class="video-icon">üìπ Video Assessment Required</span>
                </div>

                <div style="background: #fff3cd; padding: 0.75rem; border-radius: 6px; margin: 1rem 0; font-size: 0.875rem;">
                    <strong>üìù Assignment Reason:</strong> {{ assignment.assignment_reason|truncatewords:15 }}
                </div>

                <!-- Progress Bar -->
                <div class="progress-bar">
                    <div class="progress-fill" style="width: {{ assignment.progress_percentage }}%;"></div>
                </div>
                <small style="color: #666;">Progress: {{ assignment.progress_percentage }}%</small>

                <div class="assessment-info">
                    <strong class="video-icon">üìπ Video Assessment Status:</strong>
                    {% if assignment.status == 'completed' %}
                        <span style="color: #28a745;">‚úÖ Assessment Completed</span>
                        - Progress: {{ assignment.progress_percentage }}%
                    {% else %}
                        <span style="color: #6c757d;">‚è≥ Assessment Required for Completion</span>
                    {% endif %}
                </div>

                <div class="course-actions">
                    {% if assignment.status == 'recommended' %}
                        <a href="{{ assignment.course.url }}" target="_blank" class="btn-primary btn-success">üöÄ Start Course</a>
                    {% elif assignment.status == 'in_progress' %}
                        <a href="{{ assignment.course.url }}" target="_blank" class="btn-primary">üìñ Continue Learning</a>
                        <button onclick="startCourseAssessment({{ assignment.id }})" class="btn-primary video-icon">üìπ Complete Course Assessment</button>
                    {% elif assignment.status == 'completed' %}
                        <span style="color: #28a745; font-weight: 600;">‚úÖ Course Completed</span>
                        <a href="{{ assignment.course.url }}" target="_blank" class="btn-primary btn-secondary">ÔøΩ Review Course</a>
                    {% else %}
                        <button onclick="startCourseAssessment({{ assignment.id }})" class="btn-primary">üîÑ Take Assessment</button>
                    {% endif %}
                    
                    <a href="{{ assignment.course.url }}" target="_blank" class="btn-primary btn-secondary">üîó Course Link</a>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="no-courses">
                <h3>üìö No Courses Assigned Yet</h3>
                <p>Your assigned courses will appear here once they are assigned by your manager or the AI system.</p>
            </div>
        {% endif %}
    </div>
</div>

<script>
function filterCourses() {
    const statusFilter = document.getElementById('statusFilter').value;
    const typeFilter = document.getElementById('typeFilter').value;
    const courseCards = document.querySelectorAll('.course-card');
    
    courseCards.forEach(card => {
        const cardStatus = card.getAttribute('data-status');
        const cardType = card.getAttribute('data-type');
        
        const statusMatch = statusFilter === 'all' || cardStatus === statusFilter;
        const typeMatch = typeFilter === 'all' || cardType === typeFilter;
        
        if (statusMatch && typeMatch) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
}

// Auto-refresh page every 30 seconds to update progress
setTimeout(() => {
    location.reload();
}, 30000);

// Course Assessment Variables
let currentAssignmentId = null;
let assessmentStream = null;
let assessmentRecorder = null;
let recordedChunks = [];
let assessmentQuestions = [];
let assessmentAnswers = [];
let currentQuestionIdx = 0;
let assessmentTranscript = '';
let speechRecognitionFailures = 0;
let isAssessmentActive = false;

// Cheating detection variables
let cheatingFlags = {
    tabSwitches: 0,
    windowBlur: 0,
    noFaceDetected: 0,
    multipleFaces: 0,
    lookingAway: 0,
    suspicious_activity: []
};
let faceDetectionInterval = null;

function startCourseAssessment(assignmentId) {
    // Start AI assessment modal for course completion
    currentAssignmentId = assignmentId;
    document.getElementById('courseAssessmentModal').style.display = 'flex';
    document.getElementById('courseAssessmentStatus').innerText = 'Fetching course-specific questions...';
    document.getElementById('courseAssessmentQuestions').innerHTML = '';
    document.getElementById('startCourseAssessmentBtn').style.display = '';
    
    fetch(`/start-course-assessment/${assignmentId}/`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                assessmentQuestions = data.questions;
                document.getElementById('courseAssessmentQuestions').innerHTML = '<ol>' + assessmentQuestions.map(q => `<li>${q}</li>`).join('') + '</ol>';
                document.getElementById('courseAssessmentStatus').innerText = 'Ready to start course completion assessment.';
            } else {
                document.getElementById('courseAssessmentStatus').innerText = 'Error: ' + data.error;
            }
        });
}

// Course Assessment Functions (adapted from feedback assessment)
document.getElementById('closeCourseAssessmentBtn').onclick = function() {
  document.getElementById('courseAssessmentModal').style.display = 'none';
  if (assessmentStream) {
    assessmentStream.getTracks().forEach(track => track.stop());
  }
  stopCheatingDetection();
};

document.getElementById('startCourseAssessmentBtn').onclick = async function() {
  // Start webcam and course assessment
  document.getElementById('courseAssessmentStatus').innerHTML = 'üé• Starting webcam and microphone...';
  assessmentAnswers = [];
  currentQuestionIdx = 0;
  assessmentTranscript = '';
  
  try {
    // Request both video and audio permissions
    assessmentStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    document.getElementById('courseAssessmentVideo').srcObject = assessmentStream;
    
    document.getElementById('courseAssessmentStatus').innerHTML = '‚úÖ Camera and microphone ready!<br>üé¨ Starting recording...';
    
    recordedChunks = [];
    assessmentRecorder = new MediaRecorder(assessmentStream);
    assessmentRecorder.ondataavailable = e => { if (e.data.size > 0) recordedChunks.push(e.data); };
    assessmentRecorder.start();
    
    // Start cheating detection
    startCheatingDetection();
    
    // Hide start button and show progress
    document.getElementById('startCourseAssessmentBtn').style.display = 'none';
    
    document.getElementById('courseAssessmentStatus').innerHTML = `
      <strong>üé¨ Recording Started</strong><br>
      <small>Assessment will begin in 3 seconds...</small><br>
      <div style="color:#e91e63; font-size:0.8rem; margin-top:0.5rem;">
        ‚ö†Ô∏è <strong>Assessment Monitoring Active</strong><br>
        ‚Ä¢ Stay focused on the screen<br>
        ‚Ä¢ Keep your face visible to the camera<br>
        ‚Ä¢ Do not switch tabs or windows
      </div>
    `;
    
    setTimeout(() => {
      document.getElementById('courseAssessmentStatus').innerHTML = 'üé§ Starting course assessment questions...';
      askNextQuestion();
    }, 3000);
    
  } catch (e) {
    console.error('Media access error:', e);
    document.getElementById('courseAssessmentStatus').innerHTML = `
      <strong>‚ùå Media Access Error</strong><br>
      ${e.message}<br>
      <small style="color:#666;">Please ensure camera and microphone permissions are granted in your browser.</small><br>
      <button onclick="location.reload()" class="btn btn-secondary" style="margin-top:0.5rem;">Refresh & Try Again</button>
    `;
  }
};

async function askNextQuestion() {
  if (currentQuestionIdx >= assessmentQuestions.length) {
    finishCourseAssessment();
    return;
  }
  const q = assessmentQuestions[currentQuestionIdx];
  
  // Update visual feedback
  document.getElementById('courseAssessmentStatus').innerHTML = `
    <strong>Question ${currentQuestionIdx + 1} of ${assessmentQuestions.length}</strong><br>
    üé§ Speaking question...
  `;
  
  // Highlight current question in the list
  const questionsList = document.getElementById('courseAssessmentQuestions');
  questionsList.innerHTML = assessmentQuestions.map((question, idx) => {
    const isActive = idx === currentQuestionIdx;
    const isCompleted = idx < currentQuestionIdx;
    return `<li style="padding:0.5rem; margin-bottom:0.5rem; border-radius:4px; ${
      isActive ? 'background:#e3f2fd; border-left:4px solid #2196f3; font-weight:bold;' :
      isCompleted ? 'background:#e8f5e8; border-left:4px solid #4caf50; opacity:0.7;' :
      'background:#f5f5f5; opacity:0.5;'
    }">${isCompleted ? '‚úÖ ' : isActive ? 'üé§ ' : '‚è≥ '}${question}</li>`
  }).join('');
  
  // Use TTS to ask question
  const utter = new SpeechSynthesisUtterance(q);
  utter.rate = 0.9; // Slightly slower for clarity
  speechSynthesis.speak(utter);
  
  utter.onend = () => {
    // Start STT for answer
    document.getElementById('courseAssessmentStatus').innerHTML = `
      <strong>Question ${currentQuestionIdx + 1} of ${assessmentQuestions.length}</strong><br>
      üéß Listening for your answer... (Speak now)
    `;
    startSpeechRecognition();
  };
}

function finishCourseAssessment() {
  // Stop cheating detection
  stopCheatingDetection();
  
  assessmentRecorder.stop();
  assessmentRecorder.onstop = function() {
    const videoBlob = new Blob(recordedChunks, { type: 'video/webm' });
    const formData = new FormData();
    formData.append('video', videoBlob, 'course_assessment.webm');
    formData.append('transcript', assessmentTranscript);
    formData.append('questions', JSON.stringify(assessmentQuestions));
    formData.append('answers', JSON.stringify(assessmentAnswers));
    formData.append('cheating_data', JSON.stringify(cheatingFlags));
    
    document.getElementById('courseAssessmentStatus').innerHTML = `
      <strong>üîÑ Uploading and analyzing...</strong><br>
      <small>Analyzing course completion assessment...</small>
    `;
    
    fetch(`/submit-course-assessment/${currentAssignmentId}/`, {
      method: 'POST',
      body: formData
    })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        let statusHtml = `
          <strong>‚úÖ Course Assessment Complete!</strong><br>
          <div style="background:#f8f9fa; padding:1rem; border-radius:6px; margin:1rem 0; text-align:left;">
            <strong>Course:</strong> ${data.course_title}<br>
            <strong>Overall Score:</strong> ${data.ai_score}/10<br>
            <strong>Understanding:</strong> ${data.understanding}/10<br>
            <strong>Application:</strong> ${data.application}/10<br>
            <strong>Completion:</strong> ${data.completion}/10<br>
            <strong>Feedback:</strong> ${data.ai_feedback}
        `;
        
        if (data.cheating_detected) {
          statusHtml += `<br><div style="color:#e91e63; margin-top:0.5rem;"><strong>‚ö†Ô∏è Integrity Issues Detected:</strong><br>${data.cheating_details}</div>`;
        } else {
          statusHtml += `<br><div style="color:#4caf50; margin-top:0.5rem;">‚úÖ Assessment completed with integrity</div>`;
        }
        
        if (data.marked_complete) {
          statusHtml += `<br><div style="color:#4caf50; margin-top:0.5rem; font-weight:bold;">üéâ Course Marked as Complete!</div>`;
        }
        
        statusHtml += `</div>`;
        document.getElementById('courseAssessmentStatus').innerHTML = statusHtml;
        
        if (data.marked_complete) {
          setTimeout(() => location.reload(), 4000);
        }
      } else {
        document.getElementById('courseAssessmentStatus').innerHTML = `<strong>‚ùå Error:</strong> ${data.error}`;
      }
    });
  };
}

function startSpeechRecognition() {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) {
    document.getElementById('courseAssessmentStatus').innerHTML = `
      <strong>‚ö†Ô∏è Speech Recognition Not Available</strong><br>
      <button onclick="showManualInput()" class="btn btn-primary" style="margin-top:0.5rem;">Type Answer Instead</button>
    `;
    return;
  }
  
  // Auto-switch to manual input after 2 consecutive failures
  if (speechRecognitionFailures >= 2) {
    document.getElementById('courseAssessmentStatus').innerHTML = `
      <strong>üîÑ Switching to Manual Input</strong><br>
      <small style="color:#666;">Speech recognition seems to be having issues. Let's continue with typing.</small>
    `;
    setTimeout(() => showManualInput(), 1500);
    return;
  }
  
  const recognition = new SpeechRecognition();
  recognition.lang = 'en-US';
  recognition.interimResults = true; // Show interim results
  recognition.maxAlternatives = 1;
  recognition.continuous = false;
  
  let finalAnswer = '';
  let timeout;
  
  recognition.start();
  
  // Auto-stop after 30 seconds of listening
  timeout = setTimeout(() => {
    recognition.stop();
    if (!finalAnswer) {
      document.getElementById('courseAssessmentStatus').innerHTML += '<br><span style="color:orange;">‚è∞ Time limit reached. Moving to next question.</span>';
      setTimeout(() => {
        assessmentAnswers.push('No response recorded');
        assessmentTranscript += `Q${currentQuestionIdx+1}: ${assessmentQuestions[currentQuestionIdx]}\nA: No response recorded\n`;
        currentQuestionIdx++;
        askNextQuestion();
      }, 1500);
    }
  }, 30000);
  
  recognition.onresult = function(event) {
    let interimTranscript = '';
    for (let i = event.resultIndex; i < event.results.length; i++) {
      if (event.results[i].isFinal) {
        finalAnswer = event.results[i][0].transcript;
        clearTimeout(timeout);
        
        document.getElementById('courseAssessmentStatus').innerHTML = `
          <strong>Question ${currentQuestionIdx + 1} of ${assessmentQuestions.length}</strong><br>
          ‚úÖ Answer recorded: "${finalAnswer}"<br>
          <span style="color:green;">Moving to next question...</span>
        `;
        
        assessmentAnswers.push(finalAnswer);
        assessmentTranscript += `Q${currentQuestionIdx+1}: ${assessmentQuestions[currentQuestionIdx]}\nA: ${finalAnswer}\n`;
        currentQuestionIdx++;
        
        setTimeout(() => askNextQuestion(), 2000);
        return;
      } else {
        interimTranscript += event.results[i][0].transcript;
      }
    }
    
    // Show live transcription
    if (interimTranscript) {
      document.getElementById('courseAssessmentStatus').innerHTML = `
        <strong>Question ${currentQuestionIdx + 1} of ${assessmentQuestions.length}</strong><br>
        üéß Listening: <em style="color:#666;">"${interimTranscript}"</em><br>
        <small>Keep speaking or pause when finished...</small>
      `;
    }
  };
  
  recognition.onerror = function(event) {
    clearTimeout(timeout);
    speechRecognitionFailures++;
    console.error('Speech recognition error:', event.error);
    
    let errorMessage = '';
    let suggestion = '';
    
    switch(event.error) {
      case 'no-speech':
        errorMessage = 'No speech detected';
        suggestion = 'Make sure your microphone is working and speak clearly. Try again or type your answer.';
        break;
      case 'not-allowed':
        errorMessage = 'Microphone access denied';
        suggestion = 'Please allow microphone access in your browser settings and refresh the page.';
        break;
      case 'network':
        errorMessage = 'Network error';
        suggestion = 'Check your internet connection and try again.';
        break;
      default:
        errorMessage = `Speech recognition error: ${event.error}`;
        suggestion = 'Try speaking again or continue manually.';
    }
    
    // If this is the second failure, suggest manual input more prominently
    if (speechRecognitionFailures >= 2) {
      document.getElementById('courseAssessmentStatus').innerHTML = `
        <strong>‚ö†Ô∏è Multiple Speech Recognition Issues</strong><br>
        <small style="color:#666;">Let's switch to typing your answers to continue smoothly.</small><br>
        <div style="margin-top:1rem;">
          <button onclick="showManualInput()" class="btn btn-success" style="margin-right:0.5rem;">‚úçÔ∏è Type Answer (Recommended)</button>
          <button onclick="retryQuestion()" class="btn btn-secondary">üé§ Try Voice Once More</button>
        </div>
      `;
    } else {
      document.getElementById('courseAssessmentStatus').innerHTML = `
        <strong>‚ö†Ô∏è ${errorMessage}</strong><br>
        <small style="color:#666;">${suggestion}</small><br>
        <div style="margin-top:1rem;">
          <button onclick="retryQuestion()" class="btn btn-primary" style="margin-right:0.5rem;">üé§ Try Again</button>
          <button onclick="showManualInput()" class="btn btn-success" style="margin-right:0.5rem;">‚úçÔ∏è Type Answer</button>
          <button onclick="manualAnswerMode()" class="btn btn-secondary">Skip Question</button>
        </div>
      `;
    }
  };
  
  recognition.onend = function() {
    clearTimeout(timeout);
    if (!finalAnswer) {
      // If recognition ended without a final result, try again or skip
      document.getElementById('courseAssessmentStatus').innerHTML += '<br><span style="color:orange;">Recognition ended. Click to continue manually.</span><br><button onclick="manualAnswerMode()" class="btn btn-secondary" style="margin-top:0.5rem;">Skip Question</button>';
    }
  };
}

function showManualInput() {
  const currentQuestion = assessmentQuestions[currentQuestionIdx];
  document.getElementById('courseAssessmentStatus').innerHTML = `
    <strong>Question ${currentQuestionIdx + 1} of ${assessmentQuestions.length}</strong><br>
    <div style="background:#f8f9fa; padding:1rem; border-radius:6px; margin:1rem 0;">
      <strong>Q:</strong> ${currentQuestion}
    </div>
    <textarea id="manualCourseAnswer" placeholder="Type your answer here..." 
              style="width:100%; height:80px; padding:0.5rem; border:1px solid #ddd; border-radius:4px; resize:vertical;"></textarea>
    <div style="margin-top:0.5rem;">
      <button onclick="submitManualAnswer()" class="btn btn-primary">Submit Answer</button>
      <button onclick="startSpeechRecognition()" class="btn btn-secondary" style="margin-left:0.5rem;">üé§ Try Voice Again</button>
    </div>
  `;
  
  // Focus on textarea
  setTimeout(() => document.getElementById('manualCourseAnswer').focus(), 100);
}

function submitManualAnswer() {
  const answer = document.getElementById('manualCourseAnswer').value.trim();
  
  if (!answer) {
    alert('Please type your answer before submitting.');
    return;
  }
  
  document.getElementById('courseAssessmentStatus').innerHTML = `
    <strong>Question ${currentQuestionIdx + 1} of ${assessmentQuestions.length}</strong><br>
    ‚úÖ Answer recorded: "${answer}"<br>
    <span style="color:green;">Moving to next question...</span>
  `;
  
  assessmentAnswers.push(answer);
  assessmentTranscript += `Q${currentQuestionIdx+1}: ${assessmentQuestions[currentQuestionIdx]}\nA: ${answer}\n`;
  currentQuestionIdx++;
  
  setTimeout(() => askNextQuestion(), 2000);
}

function manualAnswerMode() {
  assessmentAnswers.push('Skipped - manual mode');
  assessmentTranscript += `Q${currentQuestionIdx+1}: ${assessmentQuestions[currentQuestionIdx]}\nA: Skipped - manual mode\n`;
  currentQuestionIdx++;
  askNextQuestion();
}

function retryQuestion() {
  document.getElementById('courseAssessmentStatus').innerHTML = `
    <strong>Question ${currentQuestionIdx + 1} of ${assessmentQuestions.length}</strong><br>
    üé§ Retrying... Make sure to speak clearly into your microphone.
  `;
  setTimeout(() => startSpeechRecognition(), 1000);
}

// Cheating Detection Functions (same as feedback assessment)
function startCheatingDetection() {
  isAssessmentActive = true;
  
  // Reset cheating flags
  cheatingFlags = {
    tabSwitches: 0,
    windowBlur: 0,
    noFaceDetected: 0,
    multipleFaces: 0,
    lookingAway: 0,
    suspicious_activity: []
  };
  
  // Monitor tab switching and window focus
  document.addEventListener('visibilitychange', handleVisibilityChange);
  window.addEventListener('blur', handleWindowBlur);
  window.addEventListener('focus', handleWindowFocus);
  
  // Disable right-click and common shortcuts
  document.addEventListener('contextmenu', preventCheating);
  document.addEventListener('keydown', handleKeyPress);
  
  console.log('üîí Course assessment cheating detection started');
}

function stopCheatingDetection() {
  isAssessmentActive = false;
  
  // Remove event listeners
  document.removeEventListener('visibilitychange', handleVisibilityChange);
  window.removeEventListener('blur', handleWindowBlur);
  window.removeEventListener('focus', handleWindowFocus);
  document.removeEventListener('contextmenu', preventCheating);
  document.removeEventListener('keydown', handleKeyPress);
  
  console.log('üîí Course assessment cheating detection stopped');
}

function handleVisibilityChange() {
  if (!isAssessmentActive) return;
  
  if (document.hidden) {
    cheatingFlags.tabSwitches++;
    cheatingFlags.suspicious_activity.push({
      type: 'tab_switch',
      timestamp: new Date().toISOString(),
      question: currentQuestionIdx + 1
    });
    
    // Show warning
    showCheatingWarning('Tab switching detected! Please return to the assessment.');
  }
}

function handleWindowBlur() {
  if (!isAssessmentActive) return;
  
  cheatingFlags.windowBlur++;
  cheatingFlags.suspicious_activity.push({
    type: 'window_blur',
    timestamp: new Date().toISOString(),
    question: currentQuestionIdx + 1
  });
}

function handleWindowFocus() {
  if (!isAssessmentActive) return;
  hideCheatingWarning();
}

function handleKeyPress(e) {
  if (!isAssessmentActive) return;
  
  // Prevent common cheating shortcuts
  const blockedKeys = [
    'F12', // Developer tools
    'F5',  // Refresh (unless Ctrl+F5)
    'PrintScreen'
  ];
  
  // Prevent Ctrl+combinations that could be used for cheating
  if (e.ctrlKey && ['a', 'c', 'v', 'x', 'z', 'y', 'f', 'h', 'r', 't', 'w', 'n'].includes(e.key.toLowerCase())) {
    if (!(e.key.toLowerCase() === 'r' && e.shiftKey)) { // Allow Ctrl+Shift+R
      e.preventDefault();
      cheatingFlags.suspicious_activity.push({
        type: 'blocked_shortcut',
        key: `Ctrl+${e.key}`,
        timestamp: new Date().toISOString(),
        question: currentQuestionIdx + 1
      });
      showCheatingWarning(`Keyboard shortcut blocked: Ctrl+${e.key}`);
    }
  }
  
  // Block F-keys
  if (blockedKeys.includes(e.key)) {
    e.preventDefault();
    cheatingFlags.suspicious_activity.push({
      type: 'blocked_key',
      key: e.key,
      timestamp: new Date().toISOString(),
      question: currentQuestionIdx + 1
    });
    showCheatingWarning(`Key blocked: ${e.key}`);
  }
}

function preventCheating(e) {
  if (!isAssessmentActive) return;
  
  e.preventDefault();
  cheatingFlags.suspicious_activity.push({
    type: 'right_click_attempt',
    timestamp: new Date().toISOString(),
    question: currentQuestionIdx + 1
  });
  showCheatingWarning('Right-click is disabled during assessment');
}

function showCheatingWarning(message) {
  // Create or update warning overlay
  let warningDiv = document.getElementById('cheatingWarning');
  if (!warningDiv) {
    warningDiv = document.createElement('div');
    warningDiv.id = 'cheatingWarning';
    warningDiv.style.cssText = `
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #ff5722;
      color: white;
      padding: 1rem 2rem;
      border-radius: 8px;
      z-index: 10000;
      font-weight: bold;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      animation: pulse 0.5s ease-in-out;
    `;
    document.body.appendChild(warningDiv);
  }
  
  warningDiv.innerHTML = `‚ö†Ô∏è ${message}`;
  warningDiv.style.display = 'block';
  
  // Auto-hide after 3 seconds
  setTimeout(() => hideCheatingWarning(), 3000);
}

function hideCheatingWarning() {
  const warningDiv = document.getElementById('cheatingWarning');
  if (warningDiv) {
    warningDiv.style.display = 'none';
  }
}

</script>

<!-- Course Assessment Modal -->
<div id="courseAssessmentModal" class="modal" style="display:none; position:fixed; z-index:9999; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.7); align-items:center; justify-content:center;">
  <div style="background:#fff; padding:2rem; border-radius:8px; max-width:900px; width:90%; position:relative;">
    <h3>üìö Course Completion Assessment</h3>
    <button id="closeCourseAssessmentBtn" class="btn btn-secondary" style="position:absolute; top:1rem; right:1rem;">&times;</button>
    
    <!-- Add CSS for cheating warning animations -->
    <style>
      @keyframes pulse {
        0% { transform: translateX(-50%) scale(0.9); opacity: 0; }
        50% { transform: translateX(-50%) scale(1.05); }
        100% { transform: translateX(-50%) scale(1); opacity: 1; }
      }
      
      .assessment-warning {
        animation: pulse 0.5s ease-in-out;
      }
    </style>
    
    <!-- Two-column layout: Video left, Questions right -->
    <div style="display:flex; gap:2rem; margin-top:1rem;">
      <!-- Video Section -->
      <div style="flex:1;">
        <video id="courseAssessmentVideo" width="100%" height="320" autoplay muted style="background:#222; border-radius:8px;"></video>
        <div id="courseAssessmentStatus" style="margin:1rem 0; color:#007bff; text-align:center;"></div>
        <button id="startCourseAssessmentBtn" class="btn btn-primary" style="width:100%;">Start Assessment</button>
      </div>
      
      <!-- Questions Section -->
      <div style="flex:1; padding-left:1rem; border-left:1px solid #eee;">
        <h4 style="margin-bottom:1rem; color:#333;">Course Assessment Questions</h4>
        <div id="courseAssessmentQuestions" style="height:200px; overflow-y:auto; padding:1rem; background:#f8f9fa; border-radius:6px; font-size:0.9rem; line-height:1.5;">
          <p style="color:#666; text-align:center; margin-top:2rem;">Course-specific questions will appear here when assessment starts...</p>
        </div>
        <div style="margin-top:1rem; font-size:0.85rem; color:#666;">
          <strong>Instructions:</strong> Answer questions about your course completion and learning. Demonstrate your understanding of the course content and practical applications.
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}